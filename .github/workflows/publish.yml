# Publish to PyPI
#
# Runs daily to check for new LLVM versions and automatically publish.
# Checks all major.minor versions >= 16 and publishes the latest patch for each.
#
# Manual trigger:
#   1. Go to Actions → Publish to PyPI → Run workflow
#   2. Optionally enter LLVM versions (comma-separated, e.g., "18.1.0,19.1.0,20.1.0")
#   3. Click "Run workflow"

name: Publish to PyPI

on:
  workflow_dispatch:
    inputs:
      llvm_versions:
        description: 'LLVM versions to release, comma-separated (leave empty for latest)'
        required: false
        type: string
  schedule:
    - cron: '0 10 * * *'

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine versions to publish
        id: versions
        run: |
          if [ -n "${{ inputs.llvm_versions }}" ]; then
            # Convert comma-separated input to space-separated
            versions=$(echo "${{ inputs.llvm_versions }}" | tr ',' ' ' | xargs)
            echo "Using manually specified versions: $versions"
          else
            # Get latest patch version for each major.minor >= 16
            versions=$(git -c 'versionsort.suffix=-' \
              ls-remote --exit-code --refs --sort='version:refname' --tags https://github.com/llvm/llvm-project 'llvmorg-*.*.*' \
              | sed 's/.*llvmorg-//' \
              | awk -F. '$1 >= 16' \
              | sort -t. -k1,1n -k2,2n -k3,3n \
              | awk -F. '{key=$1"."$2; versions[key]=$0} END {for (k in versions) print versions[k]}' \
              | sort -t. -k1,1n -k2,2n \
              | tr '\n' ' ')
            echo "Detected LLVM versions (latest patch per major.minor): $versions"
          fi
          echo "versions=$versions" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Publish each version sequentially
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          for version in ${{ steps.versions.outputs.versions }}; do
            echo "::group::Processing LLVM $version"

            # Fetch latest to check for existing tags and get any new commits
            git fetch origin --tags

            # Check if tag already exists
            if git rev-parse "v$version" >/dev/null 2>&1; then
              echo "Tag v$version already exists, skipping"
              echo "::endgroup::"
              continue
            fi

            # Pull latest changes (from previous iterations or other sources)
            git pull --rebase origin master

            # Download and compute hash
            echo "Downloading clang-${version}.src.tar.xz..."
            curl -fSL "https://github.com/llvm/llvm-project/releases/download/llvmorg-${version}/clang-${version}.src.tar.xz" -o "clang-${version}.src.tar.xz"
            hash=$(sha256sum "clang-${version}.src.tar.xz" | cut -d ' ' -f1)
            rm -f "clang-${version}.src.tar.xz"

            # Update version file
            echo "set(LLVM_VERSION $version)" > llvm_version.cmake
            echo "set(LLVM_SHA256 $hash)" >> llvm_version.cmake
            cat llvm_version.cmake

            # Commit and tag
            git add llvm_version.cmake
            git commit -m "Update LLVM to version $version"
            git tag "v$version"
            git push origin HEAD:master --tags

            # Build
            echo "Building wheel..."
            uv build

            # Publish to PyPI
            echo "Publishing to PyPI..."
            uv publish --trusted-publishing always

            # Clean dist for next iteration
            rm -rf dist/

            echo "::endgroup::"
          done

      - name: Create GitHub Releases
        run: |
          for version in ${{ steps.versions.outputs.versions }}; do
            # Only create release if we have the tag locally (meaning we created it)
            if git rev-parse "v$version" >/dev/null 2>&1; then
              # Check if release already exists
              if gh release view "v$version" >/dev/null 2>&1; then
                echo "Release v$version already exists, skipping"
                continue
              fi

              echo "Creating GitHub release for v$version"
              gh release create "v$version" \
                --title "v$version" \
                --notes "LLVM $version Python bindings

[LLVM Release Notes](https://releases.llvm.org/$version/docs/ReleaseNotes.html)"
            fi
          done
        env:
          GH_TOKEN: ${{ github.token }}
